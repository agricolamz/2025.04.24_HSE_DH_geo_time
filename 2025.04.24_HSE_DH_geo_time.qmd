---
title: Работа с гео-данными и временными данными
subtitle: Цифровая гуманитаристика 2024/2025
author: Г. А. Мороз
institute: Международная лаборатория языковой конвергенции, НИУ ВШЭ
date: 04/24/2025
date-format: D.MM.YYYY
format: 
  beamer:
    theme: Singapore
    mainfont: Brill
    monofont: Iosevka
    df-print: kable
    pdf-engine: xelatex
    classoption: t
    header-includes: |
       \setbeamertemplate{footline}[page number]
       \usepackage{caption}
       \captionsetup[figure]{labelformat=empty}
       \captionsetup[subfigure]{labelformat=empty}
       \setbeamercolor{alerted text}{fg=teal}
urlcolor: teal
execute:
  message: false
  warning: false
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false

# https://martinfleischmann.net/sds/
# setwd("/home/agricolamz/work/materials/2025.04.24_HSE_DH_geo_time")

library(knitr)
library(tidyverse)
library(sf)
library(maptiles)
library(tidyterra)
```

# Пространственные данные

## Анализ данных может включать

-   сбор данных
-   очистку данных и их предобработку
-   визуализацию данных
-   моделирование данных
-   дискриптивный анализ
-   предиктивный анализ
-   машинное обучение
-   ...

## Анализ пространственных данных --- это

анализ данных, который основывается на понятиях места, растояний и пространственного взаимодействия как ключевых признаков данных и использует особые инструменты и методы для хранения, визуализации и исследования такого типа данных.

## Пространственные примитивы

```{r}
#| out-width: 65%
#| fig-align: center

include_graphics("images/01_geometries.png")
```

## Какие пространственные примитивы можно здесь найти?

```{r}
#| out-width: 115%
#| fig-align: center

include_graphics("images/02_dagestan.png")
```

## Чего, как Вам кажется, здесь не хватает?

```{r}
#| out-width: 65%
#| fig-align: center

include_graphics("images/01_geometries.png")
```

\pause

Мне не хватает объема (т. е. учета высотности).

## Кладбище Стародуб (данные полевого архива [SFIRA](https://sfira.org/))

```{r}
read_csv("data/starodub.csv") |> 
  filter(!is.na(longitude)) |> 
  st_as_sf(coords = c("longitude", "latitude"),
           crs = "+proj=lonlat") |> 
  st_transform(3857) ->
  starodub

ggplot() +
  geom_sf(data = starodub) +
  coord_sf(crs = 3857)+
  theme_minimal()
```

## Кладбище Стародуб (данные полевого архива [SFIRA](https://sfira.org/))

```{r}
tile <- get_tiles(starodub, provider = "OpenStreetMap", zoom = 18)

ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.5) +
  geom_sf(data = starodub) +
  coord_sf(crs = 3857)+
  theme(text = element_text(size = 17))+
  theme_minimal()
```

## Кладбище Стародуб (данные полевого архива [SFIRA](https://sfira.org/))

```{r}
ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.5) +
  geom_sf(aes(colour = gender), data = starodub) +
  coord_sf(crs = 3857)+
  theme_minimal()+
  theme(text = element_text(size = 17))+
  scale_color_manual(values = c("#ebc106", "#396c03", "grey60")) +
  labs(color = NULL) 
```

## Кладбище Стародуб (данные полевого архива [SFIRA](https://sfira.org/))

```{r}
ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.5) +
  geom_sf(aes(colour = gender), 
          data = starodub |> filter(gender != "unknown")) +
  coord_sf(crs = 3857)+
  theme_minimal()+
  theme(text = element_text(size = 17))+
  scale_color_manual(values = c("#ebc106", "#396c03")) +
  labs(color = NULL) 
```

## Кладбище Стародуб (данные полевого архива [SFIRA](https://sfira.org/))

```{r}
ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.5) +
  geom_sf(aes(colour = year), 
          data = starodub |> 
            filter(!is.na(year))) +
  coord_sf(crs = 3857)+
  theme_minimal()+
  theme(text = element_text(size = 17))+
  scale_color_gradient(low = "darkblue", high = "tomato")+
  labs(color = NULL)+
  guides(alpha="none")
```

## [Кладбище Стародуб](https://agricolamz.github.io/2021.11.10_epigraphy/) (данные полевого архива [SFIRA](https://sfira.org/))

```{r}
ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.5) +
  geom_sf(aes(colour = year, alpha = new_year), 
          data = starodub |> 
            filter(!is.na(year)) |> 
            mutate(new_year = 1 - (year-min(year, na.rm = TRUE))/(max(year, na.rm = TRUE)-min(year, na.rm = TRUE)))) +
  coord_sf(crs = 3857)+
  theme_minimal()+
  theme(text = element_text(size = 17))+
  scale_color_gradient(low = "darkblue", high = "tomato")+
  labs(color = NULL)+
  guides(alpha="none")
```

## Ошибка выжевшего: Абрахам Вальд

```{r}
#| out-width: 100%
#| fig-align: center

include_graphics("images/03_airplane.jpg")
```

## Картографическая проекция

Любое отображение некоторого небесного тела на плоскость называют картографической проекцией. 

Если расстояния в ваших данных небольшие (особенно, если координаты близки к экватору), широту и долготу можно без страха использовать как оси в декартовой системе координат (она же --- проекция Меркатора). Однако при работе с данными масштаба страны/континента/планеты такой подход будет накопливать ошибку из-за искажений одного из следующих типов:

- искажения длин;
- искажения углов;
- искажения площадей;
- искажения форм.

## Картографическая проекция

Проекция Меркатора очень сильно искажает площади:

```{r}
#| layout-ncol: 2
#| out-width: 100%
#| fig-cap: ичтоник --- Википедия
#| fig-subcap:
#| - исходный
#| - с сохранением площадей

include_graphics("images/07-Merkator-1.png")
include_graphics("images/08-Merkator-2.png")
```

## Картографическая проекция

-   [веб-приложение](https://projectionwizard.org/), помогающее выбрать подходящую проекцию
-   [веб-приложение](https://mathigon.org/course/circles/spheres-cones-cylinders#sphere-maps), которое показывает как изменяются объекты при преобразовании с сферы на 2d
-   [Здесь](https://proj.org/en/latest/operations/projections/all_images.html) есть список всех возможных проекций

## Моделирование пространственных отношений

## Языковое сходство рутульских идиомов

```{r}
read_csv("data/rutul_points.csv") |> 
  st_as_sf(coords = c("lon", "lat"),
         crs = "+proj=lonlat") |> 
  st_transform(3857) ->
  points

read_csv("data/rutul_lines.csv") |> 
  st_as_sf(coords = c("lon", "lat"),
           crs = "+proj=lonlat") |> 
  group_by(ID, linguistic_similarity) |> 
  summarize() |> 
  st_cast("MULTILINESTRING") |>  
  st_transform(3857) ->
  lines_as_st

tile <- get_tiles(points, provider = "OpenTopoMap", zoom = 12)

ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.3) +
  geom_sf(data = lines_as_st, aes(color = linguistic_similarity), linewidth = 2)+
  geom_sf_label(data = points, aes(label = village))+
  theme_minimal()+
  scale_color_gradient(low = "royalblue", high = "tomato")+
  labs(x = NULL, y = NULL, color = NULL)
```

## Как определить соседей?

```{r}
#| out-width: 100%
#| fig-align: center

include_graphics("images/04-neighbour.png")
```

Из курса М. Фляйшманна "Spatial Data Science for Social Geography"

## Как определить соседей?

```{r}
#| out-width: 100%
#| fig-align: center

include_graphics("images/05-neighbour.png")
```

Из курса М. Фляйшманна "Spatial Data Science for Social Geography"

## Как определить соседей?

```{r}
#| out-width: 100%
#| fig-align: center

include_graphics("images/06-neighbour.png")
```

Из курса М. Фляйшманна "Spatial Data Science for Social Geography"

## Пространственная автокорреляция

## Растровые данные

## 

Мне хочется выразить благодарность Евгению Николаевичу Матерову за его блог и телеграм-канал "Наука и данные" (<https://t.me/naukaidannye>), которые значительно упростили написание этой лекции, в частности за ссылку на курс Мартина Фляйшманна "Spatial Data Science for Social Geography".

# Временные данные
